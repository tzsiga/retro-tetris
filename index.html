<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>tetris.js</title>
  <script src="js/jquery-1.10.2.min.js"></script>
  <script src="js/jquery.timer.js"></script>

  <style type="text/css">
    div#hidden {
      display: none;
    }

    table#game_area {
      border: 1px solid black;
      margin: 50px auto;
    }

    table#game_area tr {}

    table#game_area tr td {
      height: 20px;
      width: 20px;
      font-size: 0;
    }
  </style>
</head>
<body>

  <script>
    var AREA_WIDTH = 12;
    var AREA_HEIGHT = 24;
    var DEFAULT_COLOR = 'white';
    var PIECE_COLOR = 'green';
    var RESERVED = 'reserved';

    function GameTable(height, width) {
      this.height = height;
      this.width = width;
      this.squares = new Array();

      this.table = $(document.createElement('table')).attr('id', 'game_area');

      for (var i = 0; i < height; i++) {
        var new_row = $(document.createElement('tr')).attr('class', i);

        for (var j = 0; j < width; j++) {
          $(new_row).append($(document.createElement('td')).attr('class', j));
        }

        $(this.table).append(new_row);
      }

      return this;
    }

    function Square(row, column) {
      this.row = row;
      this.column = column;
      return this;
    }

    GameTable.prototype.drawSquare = function(piece) {
      $('tr.' + piece.row + ' td.' + piece.column).css('background-color', PIECE_COLOR).text(RESERVED);
    }

    GameTable.prototype.drawSquares = function() {
      gt = this;
      this.squares.forEach(function(p) {
        gt.drawSquare(p);
      });
    }

    function Block() {
      this.squares = new Array();
    }

    GameTable.prototype.addPiece = function(row, column) {
      this.squares.push(new Square(row, column));
      this.squares.push(new Square(row + 1, column + 1));
      this.squares.push(new Square(row, column + 1));
      this.squares.push(new Square(row, column + 2));
    }

    GameTable.prototype.canMovePieceDown = function(piece) {
      if ($('tr.' + (piece.row + 1) + ' td.' + piece.column).text() === RESERVED || piece.row + 1 > AREA_HEIGHT - 1)
        return false;
      return true;
    }

    GameTable.prototype.movePieceDown = function(piece) {
      if (this.canMovePieceDown(piece)) {
        $('tr.' + piece.row + ' td.' + piece.column).css('background-color', DEFAULT_COLOR).text('');
        piece.row += 1;
        $('tr.' + piece.row + ' td.' + piece.column).css('background-color', PIECE_COLOR).text(RESERVED);
      }
    }

    $(document).ready(function() {
      var gt = new GameTable(AREA_HEIGHT, AREA_WIDTH);

      $('body').append(gt.table);
      gt.addPiece(1,4);
      gt.drawSquares();
      
      var timer = $.timer(function() {
        gt.squares.forEach(function(p) {
          gt.movePieceDown(p);
        });
      });

      timer.set({ time : 100, autostart : true });
    });
  </script>

</body>
</html>
