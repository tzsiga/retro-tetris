<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <title>tetris.js</title>
  <script src="js/jquery-1.10.2.min.js"></script>
  <script src="js/jquery.timer.js"></script>

  <style type="text/css">
    div#hidden {
      display: none;
    }

    table#game_area {
      border: 1px solid black;
      margin: 50px auto;
    }

    table#game_area tr {}

    table#game_area tr td {
      height: 20px;
      width: 20px;
      font-size: 0;
    }
  </style>
</head>
<body>

  <script>
    "use strict";

    var AREA_WIDTH = 12;
    var AREA_HEIGHT = 24;
    var DEFAULT_COLOR = 'white';
    var PIECE_COLOR = 'green';
    var RESERVED = 'reserved';

    function GameTable(height, width) {
      this.height = height;
      this.width = width;
      this.blocks = new Array();

      this.table = $(document.createElement('table')).attr('id', 'game_area');

      for (var i = 0; i < height; i++) {
        var new_row = $(document.createElement('tr')).attr('class', i);

        for (var j = 0; j < width; j++) {
          $(new_row).append($(document.createElement('td')).attr('class', j));
        }

        $(this.table).append(new_row);
      }

      return this;
    }

    GameTable.prototype.addBlock = function(row, column) {
      this.blocks.push(new Block(row, column));
    }

    GameTable.prototype.drawBlocks = function() {
      var gt = this;
      gt.blocks.forEach(function(b) {
        b.drawSquares();
      });
    }

    function Block(row, column) {
      this.squares = new Array();
      this.addSquares(row, column);
    }

    Block.prototype.addSquares = function(row, column) {
      this.squares.push(new Square(row, column));
      this.squares.push(new Square(row + 1, column + 1));
      this.squares.push(new Square(row, column + 1));
      this.squares.push(new Square(row, column + 2));
    }

    Block.prototype.drawSquares = function() {
      this.squares.forEach(function(s) {
        s.draw();
      });
    }

    Block.prototype.moveDown = function() {
      this.squares.forEach(function(s) {
        s.moveDown();
      });
    }

    function Square(row, column) {
      this.row = row;
      this.column = column;
      return this;
    }

    Square.prototype.draw = function() {
      $('tr.' + this.row + ' td.' + this.column).css('background-color', PIECE_COLOR).text(RESERVED);
    }

    Square.prototype.canMoveDown = function() {
      if ($('tr.' + (this.row + 1) + ' td.' + this.column).text() === RESERVED || this.row + 1 > AREA_HEIGHT - 1)
        return false;
      return true;
    }

    Square.prototype.moveDown = function() {
      if (this.canMoveDown()) {
        $('tr.' + this.row + ' td.' + this.column).css('background-color', DEFAULT_COLOR).text('');
        this.row += 1;
        $('tr.' + this.row + ' td.' + this.column).css('background-color', PIECE_COLOR).text(RESERVED);
      }
    }

    $(document).ready(function() {
      var gt = new GameTable(AREA_HEIGHT, AREA_WIDTH);

      $('body').append(gt.table);
      gt.addBlock(1,4);
      gt.drawBlocks();
      
      var timer = $.timer(function() {
        gt.blocks.forEach(function(b) {
          b.moveDown();
        });
      });

      timer.set({ time : 100, autostart : true });
    });
  </script>

</body>
</html>
